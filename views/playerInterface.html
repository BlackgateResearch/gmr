<script language="JavaScript">

     var state = "stopped";
     var jsReady = false;
     function flashIsReady() {
        //alert('flashIsReady');
        return jsReady;
     }
     function pageInit() {
         jsReady = true;
         //document.forms["form1"].output.value += "\n" + "JavaScript is ready.\n";
     }
     function thisMovie(movieName) {
         if (navigator.appName.indexOf("Microsoft") != -1) {
             return window[movieName];
         } else {
             return document[movieName];
         }
     }

    /* JS */
    function setState(newState) {
        state = newState;
        {{ if DEBUG: }}
        console.log('Current State: ' + newState);
        {{ pass }}
        switch (newState) {
            case 'paused':
                $('#playerPause').text('Play');
                break;
            case 'playing':
                $('#playerPause').text('Pause');
                break;
            case 'stopped':
                $('#playerPause').text('Play');
                break;
        }
    }

    function lastTrack() {
        $('.trackName').text('End of playlist');
    }

    function play(url) {
        setState('playing');
        thisMovie("GMRPlayer").play(url);
        $('#currentPlaylistContainer').load('/{{=request.application}}/radio/getPlaylist.html');
    }
    function stop() {
        setState('stopped');
        thisMovie("GMRPlayer").stop();
    }

    function next() {
        $.getJSON('/{{=request.application}}/radio/nextTrack.json', function(data) {
            if (!data.end) {
                //Play and display the retrieved track
                play('{{=URL(r=request, f='download')}}' + '/' + data.track.mp3);
                $('.trackName').text(data.track.name);
                $('.trackArtist').load('{{=URL(r=request, f='jsArtistLookup')}}' + '/' + data.track.artist_id);
                $('#trackID').text(data.track.id);
                $('#barPositivity').text(data.track.positivity);
                $('#barAggression').text(data.track.aggression);
                $('#barSpeed').text(data.track.speed);
                $('#barSuspense').text(data.track.suspense);
                $('#barPositivity').addClass('nudgeBar' + data.track.positivity);
                $('#barAggression').addClass('nudgeBar' + data.track.aggression);
                $('#barSpeed').addClass('nudgeBar' + data.track.speed);
                $('#barSuspense').addClass('nudgeBar' + data.track.suspense);
            } else {
                //No more tracks to play
                stop();
                lastTrack();
            }
        });
    }   

    function getPlaylist(playlistElement) {
        $.getJSON('/{{=request.application}}/radio/nextTrack.json', function(data) {
            if (!data.end) {
                //Play and display the retrieved track
                play('{{=URL(r=request, f='download')}}' + '/' + data.track.mp3);
                $('.trackName').text(data.track.name);
                $('.trackArtist').load('{{=URL(r=request, f='jsArtistLookup')}}' + '/' + data.track.artist_id);
            } else {
                //No more tracks to play
                stop();
                lastTrack();
            }
        });
    }   


    function playPause() {
        switch(state) {
            case 'paused':
                setState('playing');
                thisMovie("GMRPlayer").pause();
                break;
            case 'playing':
                setState('paused');
                thisMovie("GMRPlayer").pause();
                break;
            case 'stopped':
                next();
                break;
        }
    }

    function progress(currentTime) {
        $('.trackSeconds').text(currentTime);
        {{ if DEBUG: }}
        console.log(currentTime);
        {{ pass }}
    }
    function soundComplete() {
        {{ if DEBUG: }}
        console.log('Sound Complete');
        {{ pass }}
        next();
    }
    function loadComplete() {
        {{ if DEBUG: }}
        console.log('Load Complete');
        {{ pass }}
    }
    function playabckStart() {
        {{ if DEBUG: }}
        console.log('Playback Started');
        {{ pass }}
    }

    function sendToJavaScript(value) {
     document.forms["form1"].output.value += "ActionScript says: " + value + "\n";
    }

    function nudge(moodComponent, direction) {
        $.ajax({
            type: "GET",
            url: "/{{=request.application}}/radio/nudge/" + $('#trackID').text() + "/" + moodComponent + "/" + direction
        });
    }
</script>
